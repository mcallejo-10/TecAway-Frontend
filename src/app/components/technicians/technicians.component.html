<!-- üîÑ Ahora usamos state.isLoading() en lugar de loading -->
@if(state.isLoading() === true) {
<app-loading-bar message="Cargando t√©cnicos/as..."></app-loading-bar>
} @if(state.isLoading() === false) {

<div class="container container-fluid mt-2">

  <button class="btn click-btn btn-style506 mt-2" (click)="toggleFilter()">Filtrar</button>
  <div class="row">

    <div class="col-12 col-md-3" id="filter">
      <!-- eslint-disable-next-line @angular-eslint/template/click-events-have-key-events, @angular-eslint/template/interactive-supports-focus -->
      <div #filterOverlay class="filter-overlay" (click)="closeFilter()"></div>
      <div #filterCard class="card filter-card ">
        <button class="filter-close" (click)="closeFilter()">√ó</button>
        
        <p class="filter-title">Ordenar por</p>
        <div class="sort-dropdown-wrapper">
          <app-dropdown
            [options]="sortOptions()"
            [selectedValue]="state.sortType()"
            (selectionChange)="onSortTypeChange($event)">
          </app-dropdown>
        </div>

        <p class="filter-title">Puesto</p>
        <div id="filter-list">
          <form [formGroup]="filterForm">
            @for (section of sectionList; track section.id_section) {
            @if(section.section !== 'Conocimientos generales') {
            <div class="form-check">
              <input type="checkbox" class="form-check-input" id="{{ 'section-' + section.id_section }}"
                [checked]="isCheckedSection(section.id_section!)"
                (change)="getSelectedSections(section.id_section!, $event)">
              <label class="form-check-label" for="'section-' + section.id_section">{{ section.section }}
              </label>
            </div>
            }
            }

          </form>
        </div>
        <div id="filtre-knowledges">

          @for (section of sectionList; track section.id_section) {
          @if(isCheckedSection(section.id_section!)) {
          <p class="filter-title">{{section.section}}</p>
          @for (knowledge of knowledgeList; track knowledge.id_knowledge) {
          @if(knowledge.section_id === section.id_section && knowledge.knowledge !== section.section) {
          <div class="form-check">
            <input type="checkbox" class="form-check-input" id="{{ 'knowledge-' + knowledge.id_knowledge }}"
              [checked]="isCheckedKnowledge(knowledge.id_knowledge!)"
              (change)="getSelectedKnowledges(knowledge.id_knowledge!, $event)">
            <label class="form-check-label" for="'knowledge-' + knowledge.id_knowledge">{{ knowledge.knowledge }}
            </label>
          </div>
          }
          }
          }
          }
        </div>

        <!-- üó∫Ô∏è PARTE 2: CONTROLES DE UBICACI√ìN Y DISTANCIA -->
        <p class="filter-title">Buscar por distancia</p>
        
        <div class="mb-3">
          <!-- Input para escribir ciudad/pa√≠s manualmente -->
          <!-- üîç B√∫squeda por ubicaci√≥n -->
          <div class="input-group mb-2 position-relative">
            <input 
              #locationInput
              type="text" 
              class="form-control"
              placeholder="Ej: Barcelona"
              (input)="onLocationInput(locationInput.value)"
              (keyup.enter)="searchByLocation(locationInput.value)">
            <button 
              class="btn btn-outline-secondary"
              type="button"
              (click)="searchByLocation(locationInput.value)">
              üîç
            </button>
            
            <!-- Dropdown de sugerencias -->
            @if(showSuggestions()) {
              <div class="dropdown-menu show w-100 position-absolute" style="top: 100%; z-index: 1000; max-height: 300px; overflow-y: auto;">
                @for(suggestion of locationSuggestions(); track suggestion.display_name) {
                  <button 
                    type="button"
                    class="dropdown-item"
                    (click)="selectLocationSuggestion(suggestion, locationInput)">
                    <div>
                      <strong>{{ suggestion.city }}</strong>, {{ suggestion.country }}
                    </div>
                    @if(suggestion.state) {
                      <small class="text-muted">{{ suggestion.state }}</small>
                    }
                  </button>
                }
              </div>
            }
          </div>
          
          <!-- Bot√≥n alternativo para usar ubicaci√≥n del navegador -->
          <button 
            type="button"
            class="btn btn-outline-primary btn-sm w-100"
            (click)="requestUserLocation()">
            üìç Usar mi ubicaci√≥n actual
          </button>
        </div>
        
        <!-- Slider de radio (solo si HAY ubicaci√≥n activa) -->
        @if(state.hasLocationFilter()) {
          <div class="mb-3">            <!-- Indicador del radio actual -->
            <div class="d-flex justify-content-between mb-2">
              <small class="text-muted">Radio de b√∫squeda:</small>
              <strong>{{ state.searchRadius() }} km</strong>
            </div>
            
            <!-- Slider para ajustar el radio -->
            <input 
              #radiusSlider
              type="range" 
              class="form-range"
              min="5"
              max="1500"
              step="5"
              [value]="state.searchRadius()"
              (input)="onSearchRadiusChange(+radiusSlider.value)">
            
            <!-- Etiquetas de rango -->
            <div class="d-flex justify-content-between">
              <small class="text-muted">5 km</small>
              <small class="text-muted">1500 km</small>
            </div>
            
            <!-- Bot√≥n para limpiar filtro de ubicaci√≥n -->
            <button 
              type="button"
              class="btn btn-outline-danger btn-sm w-100 mt-2"
              (click)="clearLocationFilter()">
              ‚úï Quitar filtro de distancia
            </button>
          </div>
        }
      </div>
    </div>



    <section class="col-12 col-md-9">
      <!-- üîÑ Ahora usamos state.filteredTechnicians() -->
      @if(state.filteredTechnicians().length === 0 ) {
      <div class="col-12 card-link">
        <div class="card card-technician">
          <div class="row g-0">
            <div class="col-2 ">
            
                <app-user-avatar 
                  [photo]="null" 
                  [name]="'Sin t√©cnicos'" 
                  [size]="getAvatarSize()" 
                  class="responsive-avatar object-fit-scale border rounded">
                </app-user-avatar>
             
            </div>
            <div class="col-10">
              <div class="card-body">
                <p class="card-title">No hay t√©cnicos disponibles</p>
                <p class="card-subtitle mb-2">Por favor, ajuste los filtros de b√∫squeda</p>
              </div>
            </div>
          </div>
        </div>
      </div>
      }


      <!-- üîÑ Iteramos sobre state.filteredTechnicians() -->
      @for(technician of state.filteredTechnicians(); track technician.id_user) {

      <div class="col-12 card-link">
        <a [routerLink]="['/user', technician.id_user]">
          <div class="card card-technician">
            <div class="row g-0">
              <div class="col-2">
                <div class="card-img">
                  <app-user-avatar 
                    [photo]="technician.photo" 
                    [name]="technician.name" 
                    [size]="getAvatarSize()"
                    class="responsive-avatar">
                  </app-user-avatar>
                </div>
              </div>
              <div class="col-10">
                <div class="card-body">
                  <p class="card-title" id="name">{{technician.name.toUpperCase()}}</p>
                  <p class="card-subtitle mb-2" id="title">{{technician.title}}</p>
                  <p class="card-subtitle mb-2" id="description">{{technician.description}}</p>
                </div>
              </div>
            </div>
          </div>
        </a>
      </div>
      }
    </section>
  </div>
</div>

}